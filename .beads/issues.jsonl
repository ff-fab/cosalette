{"id":"workspace-0a5","title":"Phase 8.3: Concept documentation (10 pages)","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T21:57:20.371594233Z","created_by":"Fabian Koerner","updated_at":"2026-02-18T18:54:27.429715937Z","closed_at":"2026-02-18T18:54:27.429715937Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-0a5","depends_on_id":"workspace-28l","type":"blocks","created_at":"2026-02-16T21:57:39.249489367Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-1xr","title":"Phase 1: Core @app.command() decorator with injection and routing","description":"Add _CommandRegistration, command() decorator, _run_command(), update _wire_router(), extend injection for topic/payload params. Red-green test cycle.","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T07:26:04.437406606Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T18:41:48.230576575Z","closed_at":"2026-02-20T18:41:48.230576575Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-1xr","depends_on_id":"workspace-b8u","type":"blocks","created_at":"2026-02-20T07:26:22.31479062Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-28l","title":"Phase 8.2: Getting Started and Quickstart tutorial","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T21:57:20.174582753Z","created_by":"Fabian Koerner","updated_at":"2026-02-18T18:01:20.020927141Z","closed_at":"2026-02-18T18:01:20.020927141Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-28l","depends_on_id":"workspace-if1","type":"blocks","created_at":"2026-02-16T21:57:39.104045527Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-2k9","title":"Phase 8.5: Reference documentation with mkdocstrings API ref","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T21:57:20.799333493Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T16:43:31.56230342Z","closed_at":"2026-02-19T16:43:31.56230342Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-2k9","depends_on_id":"workspace-2z7","type":"blocks","created_at":"2026-02-16T21:57:39.574207122Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-2p8","title":"Evaluate MqttLifecycle protocol for type-safe start/stop/on_message","description":"GATE TASK — Phase 4 review finding.\n\nCurrently _app.py uses `hasattr(mqtt, \"start\")`, `hasattr(mqtt, \"stop\")`, and `hasattr(mqtt, \"on_message\")` for duck-type capability checks. MqttPort deliberately excludes lifecycle methods (ISP), but hasattr is not type-safe — if a future adapter accidentally defines a `start` attribute (e.g. a boolean), the code will try to `await mqtt.start()`.\n\n**Decision to evaluate:** Introduce a separate `MqttLifecycle` protocol:\n\n```python\nclass MqttLifecycle(Protocol):\n    async def start(self) -\u003e None: ...\n    async def stop(self) -\u003e None: ...\n```\n\nThen replace `hasattr` checks with `isinstance(mqtt, MqttLifecycle)`.\n\n**Considerations:**\n- Keeps MqttPort narrow (ISP)\n- Adds type safety to lifecycle checks\n- MqttClient and MockMqttClient would need to satisfy both MqttPort and MqttLifecycle\n- Could be a union: `MqttPort | MqttLifecycle` or a combined `FullMqttPort(MqttPort, MqttLifecycle)`\n- on_message callback wiring needs its own protocol or stays as hasattr\n\n**Trigger:** Evaluate when building Phase 6 (testing module) or Phase 7 (public API) — whichever introduces additional MQTT adapters or formalises the public API surface.\n\n**References:**\n- _app.py lines 355, 378, 471 (hasattr calls)\n- ADR-006 (hexagonal architecture)\n- PEP 544 (structural subtyping)","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-15T12:16:30.751217415Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.176057582Z","closed_at":"2026-02-16T20:12:15.176057582Z","close_reason":"Closed","labels":["architecture","gate-task"]}
{"id":"workspace-2z7","title":"Phase 8.4: How-To Guides (8 guides incl. full app walkthrough)","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T21:57:20.601728844Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T16:21:14.564798426Z","closed_at":"2026-02-19T16:21:14.564798426Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-2z7","depends_on_id":"workspace-0a5","type":"blocks","created_at":"2026-02-16T21:57:39.397668207Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-341","title":"PR #22 fix: device proxy should log errors and handle CancelledError","description":"Copilot review finding 2: The _wire_router device proxy swallows exceptions without logging, and contextlib.suppress(Exception) around ErrorPublisher.publish() can swallow CancelledError during shutdown. Fix: add logging and tighten exception handling. Address on feat/api-ergonomics before merging PR #22.","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T11:26:45.282034142Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T18:57:51.938274995Z","closed_at":"2026-02-20T18:57:51.938274995Z","close_reason":"Closed"}
{"id":"workspace-4cx","title":"API Ergonomics: Lifespan + Runner + Injection","description":"Simplify the cosalette developer experience to match the 'FastAPI for MQTT' motto. Three pillars:\n\n1. **app.run() public entrypoint** — eliminate manual asyncio.run/signal boilerplate\n2. **@app.lifespan decorator** — replace on_startup/on_shutdown with a single async context manager (FastAPI pattern)\n3. **Signature-based injection** — handlers declare only what they need; framework resolves from known types\n\nTarget: a minimal app looks like this:\n\n```python\napp = cosalette.App('myapp', version='1.0.0', lifespan=lifespan)\n\n@app.telemetry('sensor', interval=5.0)\nasync def read_sensor() -\u003e dict[str, object]:\n    return {'temp': 22.5}\n\napp.run()\n```\n\nRemoves ~20 lines of boilerplate from the current debug app example.","status":"closed","priority":1,"issue_type":"feature","owner":"fab@tech-kyb.de","created_at":"2026-02-19T20:29:37.199626644Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T06:37:57.123917178Z","closed_at":"2026-02-20T06:37:57.123917178Z","close_reason":"All API ergonomics phases complete"}
{"id":"workspace-4zo","title":"Phase 1: Public app.run() entrypoint","description":"Add a public synchronous `app.run()` method that handles:\n\n- `asyncio.run()` loop creation\n- SIGINT / SIGTERM signal wiring → graceful shutdown\n- Optional `mqtt` injection for testing (`app.run(mqtt=mock)`)\n\n**Current state:** `app.run()` already exists in _cli.py and builds a Typer CLI.\nDecision needed: either extend the existing `run()` or add a second entrypoint\n(e.g. `app.serve()`) that bypasses CLI parsing for programmatic use.\n\n**Acceptance criteria:**\n- A minimal app can start with just `app.run()` — no manual asyncio/signal code\n- Signal handlers (SIGINT/SIGTERM) trigger graceful shutdown automatically\n- The debug app example shrinks to ~5 lines of framework code at the bottom\n- Existing CLI-based `app.run()` still works (or is merged into one path)\n- Unit tests cover: normal startup/shutdown, signal handling, mock MQTT injection\n\n**Design notes:**\n- FastAPI uses `uvicorn.run(app)` externally; we own the runner, so `app.run()` is natural\n- Consider whether CLI flags (--dry-run, --log-level) should still work via this path\n- The private `_run_async()` stays as the async core; `run()` wraps it","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-19T20:29:52.704118063Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T20:58:50.901989524Z","closed_at":"2026-02-19T20:58:50.901989524Z","close_reason":"Phase 1 complete: app.run() + cli() implemented","dependencies":[{"issue_id":"workspace-4zo","depends_on_id":"workspace-4cx","type":"blocks","created_at":"2026-02-19T20:31:37.494802315Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-6sp","title":"Phase 8: Comprehensive MkDocs documentation (DITA style)","description":"Build full documentation site using MkDocs Material with DITA information typing. Concepts: framework philosophy, hexagonal architecture, IoC pattern, device archetypes. Tasks: getting started, creating first app, adding commands, testing guide. Reference: API reference (App, DeviceContext, Settings, ClockPort), MQTT topic conventions, CLI options, configuration reference. Include architecture diagrams (mermaid), code examples from gas2mqtt.","status":"in_progress","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.573630086Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T21:56:15.190341693Z","dependencies":[{"issue_id":"workspace-6sp","depends_on_id":"workspace-vil","type":"blocks","created_at":"2026-02-14T17:11:25.45582178Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-740","title":"Build cosalette core framework (Phase 1)","status":"closed","priority":1,"issue_type":"epic","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:22.340699977Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T18:11:54.582884075Z","closed_at":"2026-02-19T18:11:54.582884075Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-740","depends_on_id":"workspace-2k9","type":"blocks","created_at":"2026-02-16T21:57:39.909485749Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-740","depends_on_id":"workspace-swy","type":"blocks","created_at":"2026-02-19T15:51:05.683349741Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-788","title":"Phase 2: MQTT Client (_mqtt.py)","description":"Generalised MqttClient from velux2mqtt reference. Lazy aiomqtt import, asyncio.Event connectivity, tracked subscriptions with reconnect restore, LWT support (configurable will topic/payload), MessageCallback dispatch, topic structure {prefix}/{device}/state|set|availability. Remove velux /actual filtering. Full test suite with MockMqttClient test double.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:42.663507272Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T21:45:39.858465387Z","closed_at":"2026-02-14T21:45:39.858465387Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-788","depends_on_id":"workspace-omb","type":"blocks","created_at":"2026-02-14T17:11:25.000552318Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-7eh","title":"Phase 4: Update examples, debug app, and docs","description":"Update all user-facing examples and documentation to use the new API:\n\n**Changes:**\n- Rewrite `cosalette_debug_app.py` to use `app.run()`, lifespan, and minimal signatures\n- Update `docs/guides/` examples (full-app.md, lifecycle-hooks.md, etc.)\n- Update `docs/concepts/lifecycle.md` to describe lifespan pattern\n- Update `docs/reference/api.md` with new API signatures\n- Update `docs/getting-started/quickstart.md`\n- Remove references to `on_startup`/`on_shutdown` across all docs\n\n**Target debug app shape:**\n```python\nimport cosalette\nfrom contextlib import asynccontextmanager\nfrom collections.abc import AsyncIterator\n\n@asynccontextmanager\nasync def lifespan(ctx: cosalette.AppContext) -\u003e AsyncIterator[None]:\n    print(f\"Starting — settings: {type(ctx.settings).__name__}\")\n    yield\n    print(\"Shutting down\")\n\napp = cosalette.App(\"debugapp\", version=\"0.1.0\", lifespan=lifespan, heartbeat_interval=10.0)\n\n@app.telemetry(\"sensor\", interval=3.0)\nasync def read_sensor() -\u003e dict[str, object]:\n    import random\n    return {\"temperature\": round(20.0 + random.uniform(-2.0, 2.0), 1)}\n\n@app.device(\"valve\")\nasync def valve(ctx: cosalette.DeviceContext) -\u003e None:\n    @ctx.on_command\n    async def handle(topic: str, payload: str) -\u003e None:\n        await ctx.publish_state({\"valve_state\": payload})\n    await asyncio.Event().wait()\n\napp.run()\n```\n\n**Acceptance criteria:**\n- Debug app uses new API, no manual asyncio/signal code\n- All docs compile without errors (`task docs:build`)\n- Examples in guides are consistent with new API","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-19T20:31:12.228212292Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T06:36:22.354050993Z","closed_at":"2026-02-20T06:36:22.354050993Z","close_reason":"Phase 4 complete: all docs updated","dependencies":[{"issue_id":"workspace-7eh","depends_on_id":"workspace-d0e","type":"blocks","created_at":"2026-02-19T20:31:37.925219716Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-7zg","title":"PR #22 fix: lifespan __aexit__ should receive real exception info","description":"Copilot review finding 1: lifespan_cm.__aexit__(None, None, None) always passes None exception info, preventing the lifespan from receiving cancellation/exception context. Fix: use async with or pass real (exc_type, exc, tb). Address on feat/api-ergonomics before merging PR #22.","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T11:26:38.850277765Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T18:57:52.172930957Z","closed_at":"2026-02-20T18:57:52.172930957Z","close_reason":"Closed"}
{"id":"workspace-8br","title":"Gate: Evaluate Depends() for scoped state injection (T-deferred)","description":"Phase trigger: after @app.command() ships. Evaluate whether Depends() is needed or if adapters cover all state sharing. See docs/planning/command-handler-redesign.md Phase 4.","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T07:26:16.331377144Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T19:24:21.734765087Z","closed_at":"2026-02-20T19:24:21.734765087Z","close_reason":"Evaluated and deferred indefinitely. Adapters cover all current state-sharing needs. Depends() remains a non-breaking future option if per-device or per-request scoped injection is needed by real users. ADR-006 already documents the decision against DI containers for this scope.","dependencies":[{"issue_id":"workspace-8br","depends_on_id":"workspace-s7t","type":"blocks","created_at":"2026-02-20T07:26:23.032845213Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-8jn","title":"Phase 7c: Full-lifecycle integration test","description":"Integration test using AppHarness: create app → register device with adapter (including factory callable) → start → publish state → receive command → respond → shutdown. Validate gas2mqtt-style pattern end-to-end.","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:32:13.813747158Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.526257415Z","closed_at":"2026-02-16T20:12:15.526257415Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-8jn","depends_on_id":"workspace-uoe","type":"blocks","created_at":"2026-02-16T19:32:23.78056996Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-9sr","title":"Phase 2: Refactor tests and examples for @app.command()","description":"Update integration tests, debug app, ensure backward compat with @app.device + @ctx.on_command.","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T07:26:15.983900249Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T13:12:20.620973394Z","closed_at":"2026-02-20T13:12:20.620976694Z","dependencies":[{"issue_id":"workspace-9sr","depends_on_id":"workspace-1xr","type":"blocks","created_at":"2026-02-20T07:26:22.486710661Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-a5u","title":"Phase 3: Error Publisher + Health (_errors.py, _health.py)","description":"ErrorPublisher: structured ErrorPayload frozen dataclass → JSON → MQTT on {app}/error and {app}/{device}/error. Pluggable error type mapping. Fire-and-forget _safe_publish(). Clock injection. Health reporter: per-device availability topic, app-level status with LWT, structured JSON heartbeat. Full test suite.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:48.796360362Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T09:50:18.917821408Z","closed_at":"2026-02-15T09:50:18.917821408Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-a5u","depends_on_id":"workspace-788","type":"blocks","created_at":"2026-02-14T17:11:25.06564667Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-b8u","title":"Epic: @app.command() FastAPI-style handler","status":"closed","priority":2,"issue_type":"epic","owner":"fab@tech-kyb.de","created_at":"2026-02-20T07:25:58.235848203Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T16:03:46.718093123Z","closed_at":"2026-02-20T16:03:46.718093123Z","close_reason":"Closed"}
{"id":"workspace-ch2","title":"Deploy cosalette to PyPI","description":"Publish cosalette as a package on PyPI for the first time. This is a learning-focused task — the developer has never published to PyPI before and wants close guidance on: (1) PyPI account setup and API tokens, (2) Trusted Publishers (OIDC) for GitHub Actions, (3) Build configuration verification (hatchling, pyproject.toml metadata), (4) Test deployment to TestPyPI first, (5) Production deployment to PyPI, (6) CI/CD automation via Release Please + GitHub Actions workflow. Reference ADR-008 (packaging and distribution) for existing decisions.","status":"open","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-19T18:14:55.407503219Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T18:14:55.407503219Z"}
{"id":"workspace-crg","title":"Re-export MockMqttClient from cosalette.testing (T-mqtt-reexport, see docs/TODO/)","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T21:23:41.704482825Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T21:28:59.760311397Z","closed_at":"2026-02-15T21:28:59.760311397Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-crg","depends_on_id":"workspace-788","type":"blocks","created_at":"2026-02-14T21:23:45.634382945Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-d0e","title":"Phase 3: Signature-based handler injection","description":"Allow device/telemetry handlers to declare only the parameters they need. The framework inspects the function signature and injects matching objects from a known set.\n\n**API examples:**\n\n```python\n# Full explicit (current style — still works)\n@app.telemetry(\"sensor\", interval=5.0)\nasync def read_sensor(ctx: cosalette.DeviceContext) -\u003e dict[str, object]:\n    return {\"temp\": 22.5}\n\n# Minimal — no args needed for simple telemetry\n@app.telemetry(\"sensor\", interval=5.0)\nasync def read_sensor() -\u003e dict[str, object]:\n    return {\"temp\": 22.5}\n\n# Cherry-pick what you need\n@app.device(\"valve\")\nasync def valve(ctx: cosalette.DeviceContext, logger: logging.Logger) -\u003e None:\n    ...\n\n# Settings only\n@app.device(\"valve\")\nasync def valve(settings: cosalette.Settings) -\u003e None:\n    ...\n```\n\n**Injectable types (resolution rules):**\n1. `DeviceContext` — the full device context (current behavior)\n2. `Settings` (or subclass) — `ctx.settings`\n3. `logging.Logger` — per-device logger (`logging.getLogger(f\"cosalette.{device_name}\")`)\n4. `ClockPort` — `ctx.clock`\n5. `asyncio.Event` — `ctx.shutdown_event` (the shutdown event)\n6. Any registered adapter port type — `ctx.adapter(PortType)`\n\n**Resolution algorithm:**\n1. At registration time (`@app.device`/`@app.telemetry`), inspect `func.__signature__`\n2. For each parameter, match by type annotation against the injectable set\n3. Store the injection plan as a list of `(param_name, resolver_callable)`\n4. At call time, build `kwargs` from the plan and call the handler\n5. Unknown/unmatchable annotations → raise `TypeError` at registration time (fail-fast)\n\n**Acceptance criteria:**\n- Handlers with no parameters work (framework injects nothing)\n- Handlers requesting `DeviceContext` get the full context (backwards compat)\n- Handlers requesting individual types get the correct resolved value\n- Type mismatches or unknown annotations raise clear errors at registration\n- Startup/lifespan injection follows same rules (for AppContext scope)\n- Unit tests cover: zero-arg, single-arg, multi-arg, unknown type error, adapter injection\n\n**Design notes:**\n- Use `inspect.signature()` + `get_type_hints()` for robust annotation resolution\n- Match by type, not by parameter name (type-first resolution, like FastAPI Depends)\n- Consider a `typing.Annotated[T, Depends(...)]`pattern for future extensibility — defer for now\n- This is NOT a full DI container — it is a fixed set of known framework types","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-19T20:30:46.209162014Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T06:36:22.174805325Z","closed_at":"2026-02-20T06:36:22.174805325Z","close_reason":"Phase 3 complete: signature-based injection","dependencies":[{"issue_id":"workspace-d0e","depends_on_id":"workspace-r5g","type":"blocks","created_at":"2026-02-19T20:31:37.773235046Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-ehk","title":"Implement periodic heartbeat scheduling (opt-in, default 60s)","description":"ADR-012 specifies periodic JSON heartbeats on {prefix}/status but the current App._run_async never calls HealthReporter.publish_heartbeat(). Add heartbeat_interval parameter to App (default 60.0, None to disable). Schedule asyncio task in Phase 3 of _run_async. Cancel on shutdown. Update quickstart and getting-started docs when implemented.","notes":"When implementing periodic heartbeat, also update the reference docs: (1) docs/reference/mqtt-topics.md heartbeat section — remove 'not yet built' caveat, (2) docs/reference/payloads.md heartbeat section — remove 'Not auto-scheduled' admonition. These were added in PR #18 to accurately reflect current state.","status":"closed","priority":2,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-18T17:12:46.388503275Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T17:31:51.231358202Z","closed_at":"2026-02-19T17:31:51.231358202Z","close_reason":"Closed"}
{"id":"workspace-eht","title":"ADR: API Ergonomics (Lifespan + Injection)","description":"Write ADR-013 documenting the API ergonomics decisions:\n\n1. **Lifespan replaces startup/shutdown hooks** — single async context manager boundary\n2. **Signature-based injection** — handlers declare only what they need\n3. **app.run() as public entrypoint** — hides asyncio/signal boilerplate\n\n**Context:** cosalette positions itself as \"FastAPI for MQTT.\" The original explicit-context API was correct for internals but created unnecessary boilerplate for users. This ADR records the shift to implicit-where-safe, explicit-where-needed.\n\n**Key decisions to document:**\n- Why lifespan over hooks (single boundary, resource safety, FastAPI familiarity)\n- Why type-based injection over name-based (deterministic, IDE-friendly, testable)\n- Why NOT a full DI container (scope is fixed framework types, not arbitrary graphs)\n- Injection resolution order and error model\n- Backwards compatibility stance (breaking change, pre-1.0)\n\n**Acceptance criteria:**\n- ADR-013 follows existing ADR format in docs/adr/\n- References relevant PEPs (PEP 544 for Protocols, PEP 612 for ParamSpec if relevant)\n- Links to FastAPI lifespan docs as prior art","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-19T20:31:27.86556952Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T06:37:56.940293754Z","closed_at":"2026-02-20T06:37:56.940293754Z","close_reason":"ADR-013 written and indexed","dependencies":[{"issue_id":"workspace-eht","depends_on_id":"workspace-r5g","type":"blocks","created_at":"2026-02-19T20:31:38.129083259Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-eht","depends_on_id":"workspace-d0e","type":"blocks","created_at":"2026-02-19T20:31:38.397892471Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-gne","title":"Phase 5: CLI scaffolding (_cli.py)","description":"Typer-based CLI. Options: --dry-run, --version, --log-level, --log-format, --env-file. Integrated with App.run() as orchestration entry point. Parse CLI → load config → configure logging → hand off to app lifecycle. Full test suite.\n\nINTEGRATION NOTE (from Phase 4): App.run() calls asyncio.run(_run_async()). Phase 5 must refactor app.run() to: (1) build Typer CLI that parses flags, (2) instantiate Settings with env_file override, (3) pass dry_run and settings into _run_async(). App.__init__ accepts dry_run: bool = False for direct use. The _run_async coroutine is the integration point — CLI wraps it; app.run() is the no-CLI shortcut. See ADR-005 for flag specs.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.391122315Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T16:35:45.758193179Z","closed_at":"2026-02-15T16:35:45.758193179Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-gne","depends_on_id":"workspace-yfr","type":"blocks","created_at":"2026-02-14T17:11:25.191787873Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-if1","title":"Phase 8.1: Doc infrastructure, mkdocstrings, nav structure, home page","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T21:57:07.55457136Z","created_by":"Fabian Koerner","updated_at":"2026-02-18T18:01:19.783636546Z","closed_at":"2026-02-18T18:01:19.783636546Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-if1","depends_on_id":"workspace-6sp","type":"blocks","created_at":"2026-02-16T21:57:38.945226809Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-k88","title":"Phase 7d: Close TODOs and gate tasks","description":"Mark T-mqtt-reexport.md as resolved. Close gate tasks workspace-unv and workspace-2p8. Housekeeping.","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:32:13.932193311Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.702671794Z","closed_at":"2026-02-16T20:12:15.702671794Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-k88","depends_on_id":"workspace-8jn","type":"blocks","created_at":"2026-02-16T19:32:23.916049063Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-lep","title":"Phase 7a: Implement gate task decisions (factory callable + lifecycle protocols)","description":"Implement the two gate task decisions: (1) Widen _AdapterEntry.impl to accept Callable[[], Any] for factory-based adapter registration, update _resolve_adapters() to handle factories vs classes. (2) Add MqttLifecycle and MqttMessageHandler protocols to _mqtt.py, replace hasattr calls in _app.py with isinstance checks. Full test coverage for both.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:31:39.397352515Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.294332008Z","closed_at":"2026-02-16T20:12:15.294332008Z","close_reason":"Closed"}
{"id":"workspace-m7y","title":"Document concrete-types-only DI constraint in build_injection_plan docstring","description":"The injection system only supports concrete types (no generics like Optional[T]). This is currently only communicated via the error message. Add explicit mention to the build_injection_plan docstring.","status":"closed","priority":4,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T18:19:44.618968193Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T18:57:52.411767022Z","closed_at":"2026-02-20T18:57:52.411767022Z","close_reason":"Closed"}
{"id":"workspace-omb","title":"Phase 1: Foundation modules — Settings, Clock, Logging","description":"Create _settings.py (Settings base with MqttSettings + LoggingSettings embedded models, pydantic-settings, env_nested_delimiter, .env support, SecretStr), _clock.py (ClockPort protocol + SystemClock), _logging.py (JsonFormatter NDJSON + configure_logging with parameterised service name). Add aiomqtt\u003e=2.5.0 and typer\u003e=0.12 to pyproject.toml dependencies. Full test suite for each module. Remove old config.py placeholder.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:35.879280606Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T19:41:37.341017865Z","closed_at":"2026-02-14T19:41:37.341017865Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-omb","depends_on_id":"workspace-zho","type":"blocks","created_at":"2026-02-14T17:11:24.940224226Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-q7k","title":"Phase 6: Testing module (cosalette.testing)","description":"cosalette/testing/ sub-package. MockMqttClient (records publish/subscribe), FakeClock (deterministic time), AppHarness (full lifecycle in test), make_settings factory, device_context fixture. Pytest plugin for auto-registration (pytest_plugins). Full test suite for the testing utilities themselves.","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.453142295Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T21:28:59.894118955Z","closed_at":"2026-02-15T21:28:59.894118955Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-q7k","depends_on_id":"workspace-yfr","type":"blocks","created_at":"2026-02-14T17:11:25.255508072Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-q7k","depends_on_id":"workspace-crg","type":"blocks","created_at":"2026-02-14T21:23:45.716738862Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-r5g","title":"Phase 2: Lifespan context manager API","description":"Replace `@app.on_startup` and `@app.on_shutdown` with a single lifespan async context manager, matching FastAPI's modern pattern.\n\n**API design:**\n\n```python\nfrom contextlib import asynccontextmanager\nfrom collections.abc import AsyncIterator\n\n@asynccontextmanager\nasync def lifespan(app: cosalette.AppContext) -\u003e AsyncIterator[None]:\n    # startup — acquire resources\n    print('Starting up')\n    yield\n    # shutdown — release resources\n    print('Shutting down')\n\napp = cosalette.App('myapp', version='1.0.0', lifespan=lifespan)\n```\n\n**Implementation:**\n- Add `lifespan` parameter to `App.__init__()` accepting `Callable[[AppContext], AsyncContextManager[None]]`\n- In `_run_async()`, replace the startup/shutdown hook calls with:\n  `async with self._lifespan(app_ctx): ...devices run here...`\n- Remove `@app.on_startup`, `@app.on_shutdown` decorators entirely (no backwards compat needed)\n- Remove `_startup_hooks` and `_shutdown_hooks` internal lists\n- If no lifespan provided, use a no-op default (`@asynccontextmanager; yield`)\n\n**Acceptance criteria:**\n- `@app.on_startup` and `@app.on_shutdown` are removed from the codebase\n- Lifespan context manager wraps the device execution phase\n- Startup code runs before devices start; teardown runs after devices stop\n- Errors in lifespan startup prevent device launch (fail-fast)\n- Errors in lifespan teardown are logged but don't mask device errors\n- `AppContext` passed to lifespan has `settings` and `adapter()` access\n- Unit tests cover: happy path, startup error, teardown error, no lifespan provided\n- Update all existing tests that use on_startup/on_shutdown\n\n**Design decisions:**\n- Lifespan receives `AppContext` (not `App`) to maintain the narrow interface principle\n- Consider: should lifespan be able to yield state (like FastAPI's `app.state`)? — defer to future task if not needed now\n- The yield boundary is the natural place for resource lifecycle (DB connections, hardware init, etc.)","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-19T20:30:12.464402696Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T21:24:28.664661503Z","closed_at":"2026-02-19T21:24:28.664661503Z","close_reason":"Phase 2 complete: lifespan replaces startup/shutdown hooks","dependencies":[{"issue_id":"workspace-r5g","depends_on_id":"workspace-4zo","type":"blocks","created_at":"2026-02-19T20:31:37.631265817Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-r9p","title":"Add logger.error() to device _proxy in _wire_router","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T18:19:29.957595299Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T18:57:52.055851894Z","closed_at":"2026-02-20T18:57:52.055851894Z","close_reason":"Closed"}
{"id":"workspace-s7t","title":"Phase 3: Documentation for @app.command()","description":"Rewrite command-device guide, update all code examples, add migration guidance, write ADR.","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T07:26:16.16036866Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T16:03:46.557533864Z","closed_at":"2026-02-20T16:03:46.557533864Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-s7t","depends_on_id":"workspace-9sr","type":"blocks","created_at":"2026-02-20T07:26:22.65775535Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-swy","title":"Add Renovate/Dependabot for automated dependency updates","description":"Set up automated dependency update tooling for the cosalette repository before PyPI release.\n\nScope:\n- Evaluate Renovate vs Dependabot (or both)\n- Configure for Python deps (pyproject.toml, uv.lock)\n- Configure for GitHub Actions workflow updates\n- Configure for pre-commit hook updates\n- Pin uv version in any CI/Dockerfile and configure auto-updates\n- Consider grouped PRs for minor/patch updates\n\nMust be done before the first PyPI release to ensure deps stay current from day one.\n\nReferences:\n- Renovate docs: https://docs.renovatebot.com/\n- Dependabot docs: https://docs.github.com/en/code-security/dependabot","status":"closed","priority":3,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-19T15:50:40.035065589Z","created_by":"Fabian Koerner","updated_at":"2026-02-19T18:06:34.591327013Z","closed_at":"2026-02-19T18:06:34.591327013Z","close_reason":"Closed","labels":["devops"]}
{"id":"workspace-unv","title":"Evaluate adapter factory pattern for constructor arguments","description":"GATE TASK — Phase 4 review finding.\n\nCurrently App._resolve_adapters() instantiates adapters with no-arg constructors: `cls()`. This works for current adapters but won't scale when real hardware adapters need configuration (serial ports, I2C addresses, API keys, etc.).\n\n**Decision to evaluate:** Introduce a factory pattern for adapter registration:\n\nOption A — Factory callable:\n```python\napp.adapter(GpioPort, lambda: RpiGpio(pin=17))\napp.adapter(GpioPort, lambda: RpiGpio(pin=17), dry_run=lambda: FakeGpio())\n```\n\nOption B — Kwargs forwarding:\n```python\napp.adapter(GpioPort, RpiGpio, kwargs={\"pin\": 17})\n```\n\nOption C — Settings-driven (adapters read from Settings):\n```python\n# Adapter pulls config from settings at instantiation\napp.adapter(GpioPort, RpiGpio)  # RpiGpio.__init__(self, settings: Settings)\n```\n\n**Considerations:**\n- Option A is most flexible (any callable)\n- Option C couples adapters to Settings (may violate SRP)\n- _AdapterEntry.impl type would change from `type | str` to `type | str | Callable`\n- Lazy string imports (`module:ClassName`) still need to work with factories\n- Current test suite uses no-arg adapters — backward compatibility required\n\n**Trigger:** Evaluate when Phase 7 (public API + integration validation) validates the gas2mqtt example against the real API. Real hardware adapters will surface this need.\n\n**References:**\n- _app.py _resolve_adapters() method\n- _app.py _AdapterEntry dataclass\n- ADR-006 (hexagonal architecture, adapter wiring)","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-15T12:16:30.731554374Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.059004568Z","closed_at":"2026-02-16T20:12:15.059004568Z","close_reason":"Closed","labels":["architecture","gate-task"]}
{"id":"workspace-uoe","title":"Phase 7b: Public API audit + cleanup","description":"Audit __init__.py exports (add new protocols, review if all 24+ symbols are intentionally public). Remove main.py placeholder. Verify py.typed. Docstring audit for all public symbols. Add MqttLifecycle, MqttMessageHandler to exports.","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:31:47.659177804Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.411516823Z","closed_at":"2026-02-16T20:12:15.411516823Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-uoe","depends_on_id":"workspace-lep","type":"blocks","created_at":"2026-02-16T19:32:23.626237803Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-uvj","title":"Add logger.debug() to bare except on get_type_hints() in _injection.py","description":"The bare except Exception on get_type_hints() silently swallows errors. Add logger.debug() to aid debugging annotation resolution problems.","status":"closed","priority":4,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-20T18:19:36.554072983Z","created_by":"Fabian Koerner","updated_at":"2026-02-20T18:57:52.293672986Z","closed_at":"2026-02-20T18:57:52.293672986Z","close_reason":"Closed"}
{"id":"workspace-v0w","title":"Isolate make_settings from ambient environment variables","description":"make_settings() disables .env loading via _env_file=None but pydantic-settings BaseSettings still reads os.environ. If CI or a developer shell has MQTT__HOST etc. set, tests silently pick up those values instead of defaults. Fix by overriding settings_customise_sources() to remove EnvSettingsSource, or by creating a dedicated TestSettings subclass. See PR #11 review comment from Codex. References: _settings.py, testing/_settings.py, ADR-007.","status":"closed","priority":3,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T06:30:54.603815351Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T21:18:13.148570508Z","closed_at":"2026-02-16T21:18:13.148570508Z","close_reason":"Closed"}
{"id":"workspace-vil","title":"Phase 7: Public API + Integration validation","description":"Final __init__.py exports: App, DeviceContext, Settings, ClockPort, etc. Full-lifecycle integration test: create app → register device → start → publish → receive command → shutdown. Validate gas2mqtt example from §8 works against API. py.typed marker, docstring audit. Remove old placeholder modules (config.py, main.py).","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.514517181Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.838210584Z","closed_at":"2026-02-16T20:12:15.838210584Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-vil","depends_on_id":"workspace-q7k","type":"blocks","created_at":"2026-02-14T17:11:25.320181461Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-gne","type":"blocks","created_at":"2026-02-14T17:11:25.391429888Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-2p8","type":"blocks","created_at":"2026-02-15T12:16:36.878836614Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-unv","type":"blocks","created_at":"2026-02-15T12:16:36.907641865Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-lep","type":"blocks","created_at":"2026-02-16T19:32:24.055370601Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-yfr","title":"Phase 4: App + DeviceContext + TopicRouter (_app.py, _context.py, _router.py)","description":"Core decorator API. App class: device registry, @app.device/@app.telemetry decorators, lifecycle hooks (@app.on_startup/@app.on_shutdown), adapter registration, app.run() orchestration (parse CLI → load config → logging → MQTT → devices → hooks → block → shutdown). DeviceContext: publish_state(), publish(), sleep(), on_command(), adapter(), shutdown_requested. TopicRouter: extract device from {prefix}/{device}/set, route to handler. AppContext for hooks. Full test suite.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:56.435398241Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T11:25:48.600541011Z","closed_at":"2026-02-15T11:25:48.600541011Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-yfr","depends_on_id":"workspace-a5u","type":"blocks","created_at":"2026-02-14T17:11:25.128141844Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-zho","title":"Phase 0: Document Architecture Decision Records","description":"Derive and document all ADRs from planning documents. Covers: framework style (IoC/decorator), MQTT topic conventions, config system (pydantic-settings), logging (JSON+text), CLI (typer), hexagonal architecture, testing strategy, packaging, Python version, topic naming, error handling, health/LWT. Write to docs/adr/ADR-NNN-title.md following the ADR format in documentation.instructions.md.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:28.938685329Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T18:56:40.101138981Z","closed_at":"2026-02-14T18:56:40.101138981Z","close_reason":"Closed"}
