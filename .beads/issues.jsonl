{"id":"workspace-2p8","title":"Evaluate MqttLifecycle protocol for type-safe start/stop/on_message","description":"GATE TASK — Phase 4 review finding.\n\nCurrently _app.py uses `hasattr(mqtt, \"start\")`, `hasattr(mqtt, \"stop\")`, and `hasattr(mqtt, \"on_message\")` for duck-type capability checks. MqttPort deliberately excludes lifecycle methods (ISP), but hasattr is not type-safe — if a future adapter accidentally defines a `start` attribute (e.g. a boolean), the code will try to `await mqtt.start()`.\n\n**Decision to evaluate:** Introduce a separate `MqttLifecycle` protocol:\n\n```python\nclass MqttLifecycle(Protocol):\n    async def start(self) -\u003e None: ...\n    async def stop(self) -\u003e None: ...\n```\n\nThen replace `hasattr` checks with `isinstance(mqtt, MqttLifecycle)`.\n\n**Considerations:**\n- Keeps MqttPort narrow (ISP)\n- Adds type safety to lifecycle checks\n- MqttClient and MockMqttClient would need to satisfy both MqttPort and MqttLifecycle\n- Could be a union: `MqttPort | MqttLifecycle` or a combined `FullMqttPort(MqttPort, MqttLifecycle)`\n- on_message callback wiring needs its own protocol or stays as hasattr\n\n**Trigger:** Evaluate when building Phase 6 (testing module) or Phase 7 (public API) — whichever introduces additional MQTT adapters or formalises the public API surface.\n\n**References:**\n- _app.py lines 355, 378, 471 (hasattr calls)\n- ADR-006 (hexagonal architecture)\n- PEP 544 (structural subtyping)","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-15T12:16:30.751217415Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.176057582Z","closed_at":"2026-02-16T20:12:15.176057582Z","close_reason":"Closed","labels":["architecture","gate-task"]}
{"id":"workspace-6sp","title":"Phase 8: Comprehensive MkDocs documentation (DITA style)","description":"Build full documentation site using MkDocs Material with DITA information typing. Concepts: framework philosophy, hexagonal architecture, IoC pattern, device archetypes. Tasks: getting started, creating first app, adding commands, testing guide. Reference: API reference (App, DeviceContext, Settings, ClockPort), MQTT topic conventions, CLI options, configuration reference. Include architecture diagrams (mermaid), code examples from gas2mqtt.","status":"open","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.573630086Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T17:11:12.573630086Z","dependencies":[{"issue_id":"workspace-6sp","depends_on_id":"workspace-vil","type":"blocks","created_at":"2026-02-14T17:11:25.45582178Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-740","title":"Build cosalette core framework (Phase 1)","status":"open","priority":1,"issue_type":"epic","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:22.340699977Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T17:10:22.340699977Z","dependencies":[{"issue_id":"workspace-740","depends_on_id":"workspace-6sp","type":"blocks","created_at":"2026-02-14T17:11:43.701308428Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-788","title":"Phase 2: MQTT Client (_mqtt.py)","description":"Generalised MqttClient from velux2mqtt reference. Lazy aiomqtt import, asyncio.Event connectivity, tracked subscriptions with reconnect restore, LWT support (configurable will topic/payload), MessageCallback dispatch, topic structure {prefix}/{device}/state|set|availability. Remove velux /actual filtering. Full test suite with MockMqttClient test double.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:42.663507272Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T21:45:39.858465387Z","closed_at":"2026-02-14T21:45:39.858465387Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-788","depends_on_id":"workspace-omb","type":"blocks","created_at":"2026-02-14T17:11:25.000552318Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-8jn","title":"Phase 7c: Full-lifecycle integration test","description":"Integration test using AppHarness: create app → register device with adapter (including factory callable) → start → publish state → receive command → respond → shutdown. Validate gas2mqtt-style pattern end-to-end.","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:32:13.813747158Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.526257415Z","closed_at":"2026-02-16T20:12:15.526257415Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-8jn","depends_on_id":"workspace-uoe","type":"blocks","created_at":"2026-02-16T19:32:23.78056996Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-a5u","title":"Phase 3: Error Publisher + Health (_errors.py, _health.py)","description":"ErrorPublisher: structured ErrorPayload frozen dataclass → JSON → MQTT on {app}/error and {app}/{device}/error. Pluggable error type mapping. Fire-and-forget _safe_publish(). Clock injection. Health reporter: per-device availability topic, app-level status with LWT, structured JSON heartbeat. Full test suite.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:48.796360362Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T09:50:18.917821408Z","closed_at":"2026-02-15T09:50:18.917821408Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-a5u","depends_on_id":"workspace-788","type":"blocks","created_at":"2026-02-14T17:11:25.06564667Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-crg","title":"Re-export MockMqttClient from cosalette.testing (T-mqtt-reexport, see docs/TODO/)","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T21:23:41.704482825Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T21:28:59.760311397Z","closed_at":"2026-02-15T21:28:59.760311397Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-crg","depends_on_id":"workspace-788","type":"blocks","created_at":"2026-02-14T21:23:45.634382945Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-gne","title":"Phase 5: CLI scaffolding (_cli.py)","description":"Typer-based CLI. Options: --dry-run, --version, --log-level, --log-format, --env-file. Integrated with App.run() as orchestration entry point. Parse CLI → load config → configure logging → hand off to app lifecycle. Full test suite.\n\nINTEGRATION NOTE (from Phase 4): App.run() calls asyncio.run(_run_async()). Phase 5 must refactor app.run() to: (1) build Typer CLI that parses flags, (2) instantiate Settings with env_file override, (3) pass dry_run and settings into _run_async(). App.__init__ accepts dry_run: bool = False for direct use. The _run_async coroutine is the integration point — CLI wraps it; app.run() is the no-CLI shortcut. See ADR-005 for flag specs.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.391122315Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T16:35:45.758193179Z","closed_at":"2026-02-15T16:35:45.758193179Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-gne","depends_on_id":"workspace-yfr","type":"blocks","created_at":"2026-02-14T17:11:25.191787873Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-k88","title":"Phase 7d: Close TODOs and gate tasks","description":"Mark T-mqtt-reexport.md as resolved. Close gate tasks workspace-unv and workspace-2p8. Housekeeping.","status":"closed","priority":2,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:32:13.932193311Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.702671794Z","closed_at":"2026-02-16T20:12:15.702671794Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-k88","depends_on_id":"workspace-8jn","type":"blocks","created_at":"2026-02-16T19:32:23.916049063Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-lep","title":"Phase 7a: Implement gate task decisions (factory callable + lifecycle protocols)","description":"Implement the two gate task decisions: (1) Widen _AdapterEntry.impl to accept Callable[[], Any] for factory-based adapter registration, update _resolve_adapters() to handle factories vs classes. (2) Add MqttLifecycle and MqttMessageHandler protocols to _mqtt.py, replace hasattr calls in _app.py with isinstance checks. Full test coverage for both.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:31:39.397352515Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.294332008Z","closed_at":"2026-02-16T20:12:15.294332008Z","close_reason":"Closed"}
{"id":"workspace-omb","title":"Phase 1: Foundation modules — Settings, Clock, Logging","description":"Create _settings.py (Settings base with MqttSettings + LoggingSettings embedded models, pydantic-settings, env_nested_delimiter, .env support, SecretStr), _clock.py (ClockPort protocol + SystemClock), _logging.py (JsonFormatter NDJSON + configure_logging with parameterised service name). Add aiomqtt\u003e=2.5.0 and typer\u003e=0.12 to pyproject.toml dependencies. Full test suite for each module. Remove old config.py placeholder.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:35.879280606Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T19:41:37.341017865Z","closed_at":"2026-02-14T19:41:37.341017865Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-omb","depends_on_id":"workspace-zho","type":"blocks","created_at":"2026-02-14T17:11:24.940224226Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-q7k","title":"Phase 6: Testing module (cosalette.testing)","description":"cosalette/testing/ sub-package. MockMqttClient (records publish/subscribe), FakeClock (deterministic time), AppHarness (full lifecycle in test), make_settings factory, device_context fixture. Pytest plugin for auto-registration (pytest_plugins). Full test suite for the testing utilities themselves.","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.453142295Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T21:28:59.894118955Z","closed_at":"2026-02-15T21:28:59.894118955Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-q7k","depends_on_id":"workspace-yfr","type":"blocks","created_at":"2026-02-14T17:11:25.255508072Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-q7k","depends_on_id":"workspace-crg","type":"blocks","created_at":"2026-02-14T21:23:45.716738862Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-unv","title":"Evaluate adapter factory pattern for constructor arguments","description":"GATE TASK — Phase 4 review finding.\n\nCurrently App._resolve_adapters() instantiates adapters with no-arg constructors: `cls()`. This works for current adapters but won't scale when real hardware adapters need configuration (serial ports, I2C addresses, API keys, etc.).\n\n**Decision to evaluate:** Introduce a factory pattern for adapter registration:\n\nOption A — Factory callable:\n```python\napp.adapter(GpioPort, lambda: RpiGpio(pin=17))\napp.adapter(GpioPort, lambda: RpiGpio(pin=17), dry_run=lambda: FakeGpio())\n```\n\nOption B — Kwargs forwarding:\n```python\napp.adapter(GpioPort, RpiGpio, kwargs={\"pin\": 17})\n```\n\nOption C — Settings-driven (adapters read from Settings):\n```python\n# Adapter pulls config from settings at instantiation\napp.adapter(GpioPort, RpiGpio)  # RpiGpio.__init__(self, settings: Settings)\n```\n\n**Considerations:**\n- Option A is most flexible (any callable)\n- Option C couples adapters to Settings (may violate SRP)\n- _AdapterEntry.impl type would change from `type | str` to `type | str | Callable`\n- Lazy string imports (`module:ClassName`) still need to work with factories\n- Current test suite uses no-arg adapters — backward compatibility required\n\n**Trigger:** Evaluate when Phase 7 (public API + integration validation) validates the gas2mqtt example against the real API. Real hardware adapters will surface this need.\n\n**References:**\n- _app.py _resolve_adapters() method\n- _app.py _AdapterEntry dataclass\n- ADR-006 (hexagonal architecture, adapter wiring)","status":"closed","priority":3,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-15T12:16:30.731554374Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.059004568Z","closed_at":"2026-02-16T20:12:15.059004568Z","close_reason":"Closed","labels":["architecture","gate-task"]}
{"id":"workspace-uoe","title":"Phase 7b: Public API audit + cleanup","description":"Audit __init__.py exports (add new protocols, review if all 24+ symbols are intentionally public). Remove main.py placeholder. Verify py.typed. Docstring audit for all public symbols. Add MqttLifecycle, MqttMessageHandler to exports.","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-16T19:31:47.659177804Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.411516823Z","closed_at":"2026-02-16T20:12:15.411516823Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-uoe","depends_on_id":"workspace-lep","type":"blocks","created_at":"2026-02-16T19:32:23.626237803Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-v0w","title":"Isolate make_settings from ambient environment variables","description":"make_settings() disables .env loading via _env_file=None but pydantic-settings BaseSettings still reads os.environ. If CI or a developer shell has MQTT__HOST etc. set, tests silently pick up those values instead of defaults. Fix by overriding settings_customise_sources() to remove EnvSettingsSource, or by creating a dedicated TestSettings subclass. See PR #11 review comment from Codex. References: _settings.py, testing/_settings.py, ADR-007.","status":"closed","priority":3,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-16T06:30:54.603815351Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T21:18:13.148570508Z","closed_at":"2026-02-16T21:18:13.148570508Z","close_reason":"Closed"}
{"id":"workspace-vil","title":"Phase 7: Public API + Integration validation","description":"Final __init__.py exports: App, DeviceContext, Settings, ClockPort, etc. Full-lifecycle integration test: create app → register device → start → publish → receive command → shutdown. Validate gas2mqtt example from §8 works against API. py.typed marker, docstring audit. Remove old placeholder modules (config.py, main.py).","status":"closed","priority":1,"issue_type":"task","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:11:12.514517181Z","created_by":"Fabian Koerner","updated_at":"2026-02-16T20:12:15.838210584Z","closed_at":"2026-02-16T20:12:15.838210584Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-vil","depends_on_id":"workspace-q7k","type":"blocks","created_at":"2026-02-14T17:11:25.320181461Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-gne","type":"blocks","created_at":"2026-02-14T17:11:25.391429888Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-2p8","type":"blocks","created_at":"2026-02-15T12:16:36.878836614Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-unv","type":"blocks","created_at":"2026-02-15T12:16:36.907641865Z","created_by":"Fabian Koerner"},{"issue_id":"workspace-vil","depends_on_id":"workspace-lep","type":"blocks","created_at":"2026-02-16T19:32:24.055370601Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-yfr","title":"Phase 4: App + DeviceContext + TopicRouter (_app.py, _context.py, _router.py)","description":"Core decorator API. App class: device registry, @app.device/@app.telemetry decorators, lifecycle hooks (@app.on_startup/@app.on_shutdown), adapter registration, app.run() orchestration (parse CLI → load config → logging → MQTT → devices → hooks → block → shutdown). DeviceContext: publish_state(), publish(), sleep(), on_command(), adapter(), shutdown_requested. TopicRouter: extract device from {prefix}/{device}/set, route to handler. AppContext for hooks. Full test suite.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:56.435398241Z","created_by":"Fabian Koerner","updated_at":"2026-02-15T11:25:48.600541011Z","closed_at":"2026-02-15T11:25:48.600541011Z","close_reason":"Closed","dependencies":[{"issue_id":"workspace-yfr","depends_on_id":"workspace-a5u","type":"blocks","created_at":"2026-02-14T17:11:25.128141844Z","created_by":"Fabian Koerner"}]}
{"id":"workspace-zho","title":"Phase 0: Document Architecture Decision Records","description":"Derive and document all ADRs from planning documents. Covers: framework style (IoC/decorator), MQTT topic conventions, config system (pydantic-settings), logging (JSON+text), CLI (typer), hexagonal architecture, testing strategy, packaging, Python version, topic naming, error handling, health/LWT. Write to docs/adr/ADR-NNN-title.md following the ADR format in documentation.instructions.md.","status":"closed","priority":1,"issue_type":"task","assignee":"Fabian Koerner","owner":"fab@tech-kyb.de","created_at":"2026-02-14T17:10:28.938685329Z","created_by":"Fabian Koerner","updated_at":"2026-02-14T18:56:40.101138981Z","closed_at":"2026-02-14T18:56:40.101138981Z","close_reason":"Closed"}
